<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WPlace AutoBOT PixelColony Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f0f0f0;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .status.success { background-color: #d4edda; color: #155724; }
        .status.error { background-color: #f8d7da; color: #721c24; }
        .status.info { background-color: #d1ecf1; color: #0c5460; }
        .button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover { background-color: #0056b3; }
        .button:disabled { background-color: #6c757d; cursor: not-allowed; }
        #console-output {
            background-color: #1e1e1e;
            color: #ffffff;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .input-group {
            margin: 10px 0;
        }
        .input-group label {
            display: inline-block;
            width: 120px;
            font-weight: bold;
        }
        .input-group input, .input-group select {
            width: 200px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü§ñ WPlace AutoBOT - PixelColony Integration Test</h1>
        
        <div class="test-section">
            <h3>üìã Test Information</h3>
            <div class="status info">
                <strong>Purpose:</strong> Test the PixelColony collaborative painting features integrated into Auto-Image.js<br>
                <strong>Test Date:</strong> <span id="test-date"></span><br>
                <strong>Backend Server:</strong> Node.js + TypeScript + WebSocket + Redis<br>
                <strong>Frontend:</strong> Auto-Image.js Bookmarklet Extension
            </div>
        </div>

        <div class="test-section">
            <h3>üöÄ Load AutoBOT Script</h3>
            <p>Click the button below to load the Auto-Image.js script with PixelColony features:</p>
            <button class="button" onclick="loadAutoImageScript()">Load Auto-Image.js</button>
            <div id="script-status" class="status info" style="display: none;">Script loading...</div>
        </div>

        <div class="test-section">
            <h3>üîß PixelColony Configuration</h3>
            <div class="input-group">
                <label>WebSocket URL:</label>
                <input type="text" id="wsUrl" value="ws://localhost:3001" placeholder="ws://localhost:3001">
            </div>
            <div class="input-group">
                <label>Mode:</label>
                <select id="testMode">
                    <option value="master">Master (Room Creator)</option>
                    <option value="slave">Slave (Task Worker)</option>
                </select>
            </div>
            <div class="input-group">
                <label>Room ID:</label>
                <input type="text" id="roomId" placeholder="Enter room ID for slave mode" maxlength="8">
            </div>
        </div>

        <div class="test-section">
            <h3>üß™ Test Functions</h3>
            <button class="button" onclick="testPixelColonyFeatures()" id="testBtn" disabled>Test PixelColony Features</button>
            <button class="button" onclick="testWebSocketConnection()" id="wsTestBtn" disabled>Test WebSocket Connection</button>
            <button class="button" onclick="testUIComponents()" id="uiTestBtn" disabled>Test UI Components</button>
            <button class="button" onclick="clearConsole()">Clear Console</button>
        </div>

        <div class="test-section">
            <h3>üìä Test Results</h3>
            <div id="test-results"></div>
        </div>

        <div class="test-section">
            <h3>üìù Console Output</h3>
            <div id="console-output"></div>
        </div>
    </div>

    <script>
        // Set current date
        document.getElementById('test-date').textContent = new Date().toLocaleString();

        // Console output capture
        const originalConsole = {
            log: console.log,
            error: console.error,
            warn: console.warn,
            info: console.info
        };

        function appendToConsole(type, message) {
            const output = document.getElementById('console-output');
            const timestamp = new Date().toLocaleTimeString();
            const formattedMessage = `[${timestamp}] [${type.toUpperCase()}] ${message}\n`;
            output.textContent += formattedMessage;
            output.scrollTop = output.scrollHeight;
        }

        // Override console methods
        console.log = function(...args) {
            originalConsole.log.apply(console, args);
            appendToConsole('log', args.join(' '));
        };

        console.error = function(...args) {
            originalConsole.error.apply(console, args);
            appendToConsole('error', args.join(' '));
        };

        console.warn = function(...args) {
            originalConsole.warn.apply(console, args);
            appendToConsole('warn', args.join(' '));
        };

        console.info = function(...args) {
            originalConsole.info.apply(console, args);
            appendToConsole('info', args.join(' '));
        };

        function clearConsole() {
            document.getElementById('console-output').textContent = '';
        }

        function updateStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.className = `status ${type}`;
                element.style.display = 'block';
            }
        }

        function loadAutoImageScript() {
            updateStatus('script-status', 'Loading Auto-Image.js script...', 'info');
            
            // Load the script dynamically
            const script = document.createElement('script');
            script.src = './Auto-Image.js';
            script.onload = function() {
                updateStatus('script-status', '‚úÖ Auto-Image.js loaded successfully!', 'success');
                
                // Enable test buttons
                document.getElementById('testBtn').disabled = false;
                document.getElementById('wsTestBtn').disabled = false;
                document.getElementById('uiTestBtn').disabled = false;
                
                console.log('üéâ Auto-Image.js with PixelColony features loaded!');
                
                // Check if PixelColony features are available
                if (typeof PixelColony !== 'undefined') {
                    console.log('‚úÖ PixelColony object detected');
                    console.log('‚úÖ PixelColony functions:', Object.keys(PixelColony));
                } else {
                    console.warn('‚ö†Ô∏è PixelColony object not found');
                }
            };
            
            script.onerror = function() {
                updateStatus('script-status', '‚ùå Failed to load Auto-Image.js script', 'error');
                console.error('‚ùå Failed to load Auto-Image.js script');
            };
            
            document.head.appendChild(script);
        }

        function testPixelColonyFeatures() {
            console.log('üß™ Testing PixelColony features...');
            
            const results = [];
            
            try {
                // Test 1: Check if PixelColony object exists
                if (typeof PixelColony !== 'undefined') {
                    results.push('‚úÖ PixelColony object exists');
                    console.log('‚úÖ Test 1 passed: PixelColony object exists');
                } else {
                    results.push('‚ùå PixelColony object not found');
                    console.error('‚ùå Test 1 failed: PixelColony object not found');
                }

                // Test 2: Check required functions
                const requiredFunctions = [
                    'connect', 'sendMessage', 'handleMessage', 'createRoom', 
                    'joinRoom', 'leaveRoom', 'paintTask', 'updateModeUI'
                ];
                
                let functionsOk = true;
                for (const func of requiredFunctions) {
                    if (typeof PixelColony[func] === 'function') {
                        console.log(`‚úÖ PixelColony.${func} function exists`);
                    } else {
                        console.error(`‚ùå PixelColony.${func} function missing`);
                        functionsOk = false;
                    }
                }
                
                if (functionsOk) {
                    results.push('‚úÖ All required PixelColony functions exist');
                } else {
                    results.push('‚ùå Some PixelColony functions are missing');
                }

                // Test 3: Check Utils functions
                if (typeof Utils !== 'undefined' && typeof Utils.generateId === 'function') {
                    const testId = Utils.generateId();
                    results.push(`‚úÖ Utils.generateId works: ${testId}`);
                    console.log(`‚úÖ Test 3 passed: Utils.generateId generated: ${testId}`);
                } else {
                    results.push('‚ùå Utils.generateId function missing');
                    console.error('‚ùå Test 3 failed: Utils.generateId function missing');
                }

                // Test 4: Check state variables
                if (typeof state !== 'undefined' && state.pixelColonyEnabled !== undefined) {
                    results.push(`‚úÖ PixelColony state variables initialized: pixelColonyEnabled=${state.pixelColonyEnabled}`);
                    console.log(`‚úÖ Test 4 passed: PixelColony state initialized`);
                } else {
                    results.push('‚ùå PixelColony state variables not found');
                    console.error('‚ùå Test 4 failed: PixelColony state variables not found');
                }

            } catch (error) {
                results.push(`‚ùå Test error: ${error.message}`);
                console.error('‚ùå Test error:', error);
            }

            // Display results
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = '<h4>Test Results:</h4>' + 
                results.map(result => `<div class="status ${result.includes('‚úÖ') ? 'success' : 'error'}">${result}</div>`).join('');
        }

        function testWebSocketConnection() {
            console.log('üîå Testing WebSocket connection...');
            
            const wsUrl = document.getElementById('wsUrl').value;
            
            try {
                const ws = new WebSocket(wsUrl);
                
                ws.onopen = function() {
                    console.log('‚úÖ WebSocket connection opened successfully');
                    updateStatus('test-results', '‚úÖ WebSocket connection test passed', 'success');
                    
                    // Send a test message
                    const testMessage = {
                        type: 'test',
                        version: 'v1',
                        timestamp: new Date().toISOString(),
                        id: 'test-' + Date.now(),
                        data: { message: 'Hello from test client' }
                    };
                    
                    ws.send(JSON.stringify(testMessage));
                    console.log('üì§ Sent test message:', testMessage);
                };
                
                ws.onmessage = function(event) {
                    console.log('üì• Received WebSocket message:', event.data);
                    try {
                        const message = JSON.parse(event.data);
                        console.log('üì® Parsed message:', message);
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Could not parse WebSocket message');
                    }
                };
                
                ws.onerror = function(error) {
                    console.error('‚ùå WebSocket error:', error);
                    updateStatus('test-results', '‚ùå WebSocket connection test failed', 'error');
                };
                
                ws.onclose = function() {
                    console.log('üì± WebSocket connection closed');
                };
                
                // Close connection after 5 seconds
                setTimeout(() => {
                    if (ws.readyState === WebSocket.OPEN) {
                        ws.close();
                        console.log('üîå WebSocket test connection closed');
                    }
                }, 5000);
                
            } catch (error) {
                console.error('‚ùå WebSocket test failed:', error);
                updateStatus('test-results', `‚ùå WebSocket test error: ${error.message}`, 'error');
            }
        }

        function testUIComponents() {
            console.log('üé® Testing UI components...');
            
            // Check if the main Auto-Image UI was created
            const uiElements = [
                'wplace-container',
                'soloModeBtn',
                'masterModeBtn', 
                'slaveModeBtn',
                'pixelColonyConnectBtn',
                'createRoomBtn',
                'joinRoomBtn'
            ];
            
            const results = [];
            
            for (const elementId of uiElements) {
                const element = document.getElementById(elementId);
                if (element) {
                    results.push(`‚úÖ UI element found: ${elementId}`);
                    console.log(`‚úÖ UI element found: ${elementId}`);
                } else {
                    results.push(`‚ùå UI element missing: ${elementId}`);
                    console.warn(`‚ö†Ô∏è UI element missing: ${elementId}`);
                }
            }
            
            // Display results
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = '<h4>UI Component Test Results:</h4>' + 
                results.map(result => `<div class="status ${result.includes('‚úÖ') ? 'success' : 'error'}">${result}</div>`).join('');
        }

        // Initialize console
        console.log('üéØ PixelColony Test Environment Initialized');
        console.log('üìù Ready to test Auto-Image.js with PixelColony features');
    </script>
</body>
</html>
